<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Omer Counter with Rabbi Schachter's Approach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Latin Modern Roman, sans-serif; 
      text-align: center; 
      padding: 20px; 
      max-width: 800px; 
      margin: auto; 
      line-height: 1.6;
    }
    h1 { font-size: 1.8em; margin-bottom: 0.5em; }
    h2 { font-size: 1.4em; margin-top: 1.5em; margin-bottom: 0.5em; }
    h3 { font-size: 1.2em; margin-top: 1.2em; margin-bottom: 0.5em; }
    input[type="date"] { margin-top: 10px; font-size: 1rem; }
    img { max-width: 100%; margin: 20px 0; border: 1px solid #ccc; }
    .meta { margin-top: 10px; font-size: 0.95em; color: #333; }
    button, a.button {
      display: inline-block;
      margin: 5px;
      padding: 10px 15px;
      font-size: 1rem;
      background: #2d72d9;
      color: white;
      border: none;
      border-radius: 5px;
      text-decoration: none;
    }
    
    /* Explanation Section */
    .explanation {
      text-align: left;
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .talmudic-text {
      font-family: 'David CLM', 'Times New Roman', serif;
      direction: rtl;
      text-align: right;
      margin: 15px 0;
      font-size: 1.1em;
      line-height: 1.7;
      background-color: #f0f4f8;
      padding: 15px;
      border-radius: 5px;
    }
    
    .comparison {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    
    @media (min-width: 640px) {
      .comparison {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .counting-method {
      background-color: #f0f4f8;
      border-radius: 8px;
      padding: 15px;
      text-align: left;
    }
    
    .highlight {
      background-color: #ffeb3b50;
      padding: 2px 4px;
      border-radius: 3px;
    }
    
    .source {
      font-size: 0.8em;
      color: #666;
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    
    /* Counter Section */
    .counter-section {
      margin-bottom: 30px;
    }
    
    .omer-note {
      font-size: 0.95em;
      margin-bottom: 1em;
      color: #333; /* Default for light mode */
    }
    
    #nav-arrows {
      margin: 10px 0;
    }
    
    #nav-arrows button {
      font-size: 1.5rem;
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0 15px;
    }
    
    .schachter-attribution {
      font-style: italic;
      margin-top: 5px;
      margin-bottom: 15px;
      font-size: 0.95em;
      color: #555;
    }
    
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #121212;
        color: #f1f1f1;
      }
<<<<<<< HEAD
      .explanation {
        background-color: #1e1e1e;
      }
      .talmudic-text, .counting-method {
        background-color: #252525;
        color: #e0e0e0;
      }
=======
>>>>>>> 3c3da794c418b41583a1aacd4c82b4f0334f9d8c
      input[type="date"] {
        background-color: #1e1e1e;
        color: #f1f1f1;
        border: 1px solid #444;
      }
      img {
        border-color: #555;
      }
      .meta {
        color: #ccc;
      }
      button, a.button {
        background: #3a8dde;
        color: white;
      }
<<<<<<< HEAD
      .omer-note, .source {
        color: #ccc;
      }
      .highlight {
        background-color: #ffd60050;
      }
      .schachter-attribution {
        color: #aaa;
      }
=======
      .omer-note {
        color: #ccc;
      }
    }

    .omer-note {
      font-size: 0.95em;
      margin-bottom: 1em;
      color: #333; /* Default for light mode */
    }

    #nav-arrows {
      margin: 10px 0;
    }

    #nav-arrows button {
      font-size: 1.5rem;
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0 15px;
>>>>>>> 3c3da794c418b41583a1aacd4c82b4f0334f9d8c
    }
  </style>
</head>
<body>
<<<<<<< HEAD
  <h1>Counting the Omer</h1>
  <p class="schachter-attribution">According to Rabbi Hershel Schachter's linguistic approach of <span class="talmudic-text" style="display: inline; padding: 3px;">מָר כִּי אַתְרֵיהּ</span> (each according to their place)</p>
  
  <div class="counter-section">
    <p class="omer-note" id="omerInstructionNote">
      Loading Omer count details...
    </p>
    <input type="date" id="datePicker">
    <div id="nav-arrows">
      <button id="prevDay" aria-label="Previous Day">←</button>
      <button id="nextDay" aria-label="Next Day">→</button>
    </div>
    <div id="output"></div>
    <div class="meta" id="hebrewDate"></div>
    <div id="actions"></div>
  </div>
  
  <div class="explanation">
    <h2>Rabbi Hershel Schachter's Approach to Counting the Omer</h2>
    
    <p>Rabbi Hershel Schachter, a prominent <em>posek</em> and Rosh Yeshiva at Rabbi Isaac Elchanan Theological Seminary (RIETS), addresses an intriguing question regarding the proper formulation when counting the Omer. His approach is based on a Talmudic passage in Tractate Yoma that reveals how regional linguistic patterns should influence ritual declarations.</p>
    
    <h3>The Talmudic Background</h3>
    
    <p>The foundation of Rabbi Schachter's approach lies in Tractate Yoma 55a, which describes the Kohen Gadol's counting of blood sprinklings on Yom Kippur:</p>
    
    <div class="talmudic-text">
      תָּנוּ רַבָּנַן: אַחַת, אַחַת וְאַחַת, אַחַת וּשְׁתַּיִם, אַחַת וְשָׁלֹשׁ, אַחַת וְאַרְבַּע, אַחַת וְחָמֵשׁ, אַחַת וָשֵׁשׁ, אַחַת וָשֶׁבַע, דִּבְרֵי רַבִּי מֵאִיר. רַבִּי יְהוּדָה אוֹמֵר: אַחַת, אַחַת וְאַחַת, שְׁתַּיִם וְאַחַת, שָׁלֹשׁ וְאַחַת, אַרְבַּע וְאַחַת, חָמֵשׁ וְאַחַת, שֵׁשׁ וְאַחַת, שֶׁבַע וְאַחַת.
    </div>
    
    <p>"The Rabbis taught: [When the Kohen Gadol counts the sprinklings, he says:] 'One, one and one, one and two, one and three, one and four, one and five, one and six, one and seven.' These are the words of Rabbi Meir. Rabbi Yehuda says: [He counts:] 'One, one and one, two and one, three and one, four and one, five and one, six and one, seven and one.'"</p>
    
    <p>The Gemara then reconciles this apparent dispute:</p>
    
    <div class="talmudic-text">
      וְלָא פְּלִיגִי: מָר כִּי אַתְרֵיהּ וּמָר כִּי אַתְרֵיהּ.
    </div>
    
    <p>"And they do not disagree: one [speaks] according to [the counting convention in] his place, and one [speaks] according to [the counting convention in] his place."</p>
    
    <p>This resolution indicates that the difference between Rabbi Meir and Rabbi Yehuda is not a substantive disagreement about halakha, but rather reflects the different linguistic conventions of their respective regions. The formulation of the count is determined by regional counting practices and speech patterns.</p>
    
    <h3>The Magen Avraham's Application</h3>
    
    <p>Rabbi Schachter draws upon the commentary of the Magen Avraham (Rabbi Abraham Abele Gombiner, 1635-1682) on Orach Chaim 489:5, who applies this Talmudic principle to the counting of the Omer:</p>
    
    <div class="talmudic-text">
      יאמר לעולם מנין המועט קודם כגון א' ועשרים יום ע' בא"ע סי' קכ"ו מיהו ביומא דף נ"ה איתא דהכל לפי מנהג המדינה בחשבונם ובמדינתינו אף בלשון חול מזכירין מנין המועט קודם
    </div>
    
    <p>"One should always mention the smaller number first, such as 'one and twenty days' as seen in Even Ha'ezer 126. However, in Yoma 55a it states that everything follows the counting custom of the country, and in our country, even in secular speech, we mention the smaller number first."</p>
    
    <h3>Comparison of Counting Methods</h3>
    
    <div class="comparison">
      <div class="counting-method">
        <h4>Traditional Method (Smaller Number First)</h4>
        <div class="talmudic-text">היום אֶחָד וְעֶשְׂרִים יוֹם, שֶׁהֵם שְׁלשָׁה שָׁבוּעוֹת בָּעֹֽמֶר</div>
        <p>"Today is one and twenty days, which are three weeks of the Omer"</p>
        <p class="note">This follows the traditional Yiddish counting style: <span class="highlight">ein un tsvantsik</span> (one and twenty)</p>
      </div>
      
      <div class="counting-method">
        <h4>Modern Convention (Larger Number First)</h4>
        <div class="talmudic-text">היום עֶשְׂרִים וְאֶחָד יוֹם, שֶׁהֵם שְׁלשָׁה שָׁבוּעוֹת בָּעֹֽמֶר</div>
        <p>"Today is twenty-one days, which are three weeks of the Omer"</p>
        <p class="note">This follows modern Hebrew and English convention: <span class="highlight">עשרים ואחד</span> (twenty-one)</p>
      </div>
    </div>
    
    <h3>Rabbi Schachter's Modern Application</h3>
    
    <p>Rabbi Schachter observes that the linguistic convention referenced by the Magen Avraham—placing the smaller number first—was common in Yiddish, the vernacular of many Jewish communities in previous centuries. The Magen Avraham explicitly states: <span class="talmudic-text" style="display: inline; padding: 3px;">ובמדינתינו אף בלשון חול מזכירין מנין המועט קודם</span> (and in our country, even in everyday speech, we mention the smaller number first).</p>
    
    <p>However, contemporary language conventions in both modern Hebrew and English typically place the larger number first ("twenty-one" rather than "one and twenty"). Rabbi Schachter argues that applying the principle of <span class="talmudic-text" style="display: inline; padding: 3px;">מָר כִּי אַתְרֵיהּ</span> today would mean expressing the count as "today is twenty-one days" rather than "today is one and twenty days."</p>
    
    <p>According to Rabbi Schachter, this linguistic adaptation is a form of <span class="talmudic-text" style="display: inline; padding: 3px;">הידור מצוה</span> (enhancement of the commandment) based on the Talmudic principle. The appropriate formulation should be <span class="talmudic-text" style="display: inline; padding: 3px;">כפי יופי הסיגנון</span> (according to the beauty of expression) in the local vernacular.</p>
    
    <p>Despite the strength of Rabbi Schachter's argument, prayer books continue to use the traditional formulation with the smaller number mentioned first. This creates a tension between adherence to printed texts and the logic of adapting to contemporary linguistic norms.</p>
    
    <p>For practical purposes, the difference in formulation does not invalidate the counting (<span class="talmudic-text" style="display: inline; padding: 3px;">בדיעבד</span> one fulfills the obligation regardless), but there is still an ideal way (<span class="talmudic-text" style="display: inline; padding: 3px;">לכתחילה</span>) to perform the mitzvah that would align with contemporary speech patterns.</p>
    
    <div class="source">Based on Rabbi Hershel Schachter's teachings and rabbinic writings. Sources include Tractate Yoma 55a and Magen Avraham on Orach Chaim 489:5.</div>
=======
  <h1>Today's Omer Count</h1>
  <p class="omer-note" id="omerInstructionNote">
    Loading Omer count details...
  </p>
  <input type="date" id="datePicker">
  <div id="nav-arrows">
    <button id="prevDay" aria-label="Previous Day">←</button>
    <button id="nextDay" aria-label="Next Day">→</button>
>>>>>>> 3c3da794c418b41583a1aacd4c82b4f0334f9d8c
  </div>

  <script>
    const base = 'images';
    const startDates = {
      2024: '2024-04-23',
      2025: '2025-04-13', 2026: '2026-04-02', 2027: '2027-04-22', 2028: '2028-04-11',
      2029: '2029-03-31', 2030: '2030-04-18', 2031: '2031-04-08', 2032: '2032-03-27',
      2033: '2033-04-14', 2034: '2034-04-04', 2035: '2035-04-24', 2036: '2036-04-12',
      2037: '2037-03-31', 2038: '2038-04-20', 2039: '2039-04-09', 2040: '2040-03-29',
      2041: '2041-04-16', 2042: '2042-04-05', 2043: '2043-04-25', 2044: '2044-04-12',
      2045: '2045-04-02', 2046: '2046-04-21', 2047: '2047-04-11', 2048: '2048-03-29',
      2049: '2049-04-17', 2050: '2050-04-07', 2051: '2051-03-28', 2052: '2052-04-14',
      2053: '2053-04-03', 2054: '2054-04-23', 2055: '2055-04-13', 2056: '2056-04-01',
      2057: '2057-04-19', 2058: '2058-04-09', 2059: '2059-03-29', 2060: '2060-04-15',
      2061: '2061-04-05', 2062: '2062-04-25', 2063: '2063-04-14', 2064: '2064-04-01',
      2065: '2065-04-21', 2066: '2066-04-10', 2067: '2067-03-31', 2068: '2068-04-17',
      2069: '2069-04-06', 2070: '2070-03-27', 2071: '2071-04-14', 2072: '2072-04-03',
      2073: '2073-04-22', 2074: '2074-04-12', 2075: '2075-03-31', 2076: '2076-04-18',
      2077: '2077-04-08', 2078: '2078-03-29', 2079: '2079-04-16', 2080: '2080-04-04',
      2081: '2081-04-24', 2082: '2082-04-14', 2083: '2083-04-03', 2084: '2084-04-20',
      2085: '2085-04-10', 2086: '2086-03-30', 2087: '2087-04-17', 2088: '2088-04-06',
      2089: '2089-03-26', 2090: '2090-04-15', 2091: '2091-04-03', 2092: '2092-04-22',
      2093: '2093-04-11', 2094: '2094-04-01', 2095: '2095-04-19', 2096: '2096-04-07',
      2097: '2097-03-28', 2098: '2098-04-17', 2099: '2099-04-05', 2100: '2100-04-24',
      2101: '2101-04-14', 2102: '2102-04-04', 2103: '2103-04-22', 2104: '2104-04-10',
      2105: '2105-03-31', 2106: '2106-04-20', 2107: '2107-04-09', 2108: '2108-03-27',
      2109: '2109-04-16', 2110: '2110-04-05', 2111: '2111-04-23', 2112: '2112-04-12',
      2113: '2113-04-01', 2114: '2114-04-21', 2115: '2115-04-09', 2116: '2116-03-28',
      2117: '2117-04-17', 2118: '2118-04-07', 2119: '2119-04-25', 2120: '2120-04-13',
      2121: '2121-04-03', 2122: '2122-04-21', 2123: '2123-04-11', 2124: '2124-03-30',
      2125: '2125-04-19'
    };

    const omerCounts = [ // Ensure you have all 49 counts here
        "היום יוֹם אֶחָד בָּעֹֽמֶר:", "היום שְׁנֵי יָמִים בָּעֹֽמֶר:", "היום שְׁלשָׁה יָמִים בָּעֹֽמֶר:",
        "היום אַרְבָּעָה יָמִים בָּעֹֽמֶר:", "היום חֲמִשָּׁה יָמִים בָּעֹֽמֶר:", "היום שִׁשָּׁה יָמִים בָּעֹֽמֶר:",
        "היום שִׁבְעָה יָמִים שֶׁהֵם שָׁבוּעַ אֶחָד בָּעֹֽמֶר:", "היום שְׁמוֹנָה יָמִים שֶׁהֵם שָׁבוּעַ אֶחָד וְיוֹם אֶחָד בָּעֹֽמֶר:",
        "היום תִּשְׁעָה יָמִים שֶׁהֵם שָׁבוּעַ אֶחָד וּשְׁנֵי יָמִים בָּעֹֽמֶר:", "היום עֲשָׂרָה יָמִים שֶׁהֵם שָׁבוּעַ אֶחָד וּשְׁלוֹשָׁה יָמִים בָּעֹֽמֶר:",
        "היום אַחַד עָשָׂר יוֹם שֶׁהֵם שָׁבוּעַ אֶחָד וְאַרְבָּעָה יָמִים בָּעֹֽמֶר:", "היום שְׁנֵים עָשָׂר יוֹם שֶׁהֵם שָׁבוּעַ אֶחָד וַחֲמִשָּׁה יָמִים בָּעֹֽמֶר:",
        "היום שְׁלשָׁה עָשָׂר יוֹם שֶׁהֵם שָׁבוּעַ אֶחָד וְשִׁשָּׁה יָמִים בָּעֹֽמֶר:", "היום אַרְבָּעָה עָשָׂר יוֹם שֶׁהֵם שְׁנֵי שָׁבוּעוֹת בָּעֹמֶר:",
        "היום חֲמִשָּׁה עָשָׂר יוֹם שֶׁהֵם שְׁנֵי שָׁבוּעוֹת וְיוֹם אֶחָד בָּעֹֽמֶר:", "היום שִׁשָּׁה עָשָׂר יוֹם שֶׁהֵם שְׁנֵי שָׁבוּעוֹת וּשְׁנֵי יָמִים בָּעֹֽמֶר:",
        "היום שִׁבְעָה עָשָׂר יוֹם שֶׁהֵם שְׁנֵי שָׁבוּעוֹת וּשְׁלוֹשָׁה יָמִים בָּעֹֽמֶר:", "היום שְׁמוֹנָה עָשָׂר יוֹם שֶׁהֵם שְׁנֵי שָׁבוּעוֹת וְאַרְבָּעָה יָמִים בָּעֹֽמֶר:",
        "היום תִּשְׁעָה עָשָׂר יוֹם שֶׁהֵם שְׁנֵי שָׁבוּעוֹת וַחֲמִשָּׁה יָמִים בָּעֹֽמֶר:", "היום עֶשְׂרִים יוֹם שֶׁהֵם שְׁנֵי שָׁבוּעוֹת וְשִׁשָּׁה יָמִים בָּעֹֽמֶר:",
        "היום עֶשְׂרִים וְאֶחָד יוֹם שֶׁהֵם שְׁלֹשָׁה שָׁבוּעוֹת בָּעֹמֶר:", "היום עֶשְׂרִים וּשְׁנַיִם יוֹם שֶׁהֵם שְׁלֹשָׁה שָׁבוּעוֹת וְיוֹם אֶחָד בָּעֹמֶר:",
        "היום עֶשְׂרִים וּשְׁלוֹשָׁה יוֹם שֶׁהֵם שְׁלֹשָׁה שָׁבוּעוֹת וּשְׁנֵי יָמִים בָּעֹמֶר:", "היום עֶשְׂרִים וְאַרְבָּעָה יוֹם שֶׁהֵם שְׁלֹשָׁה שָׁבוּעוֹת וּשְׁלוֹשָׁה יָמִים בָּעֹמֶר:",
        "היום עֶשְׂרִים וַחֲמִשָּׁה יוֹם שֶׁהֵם שְׁלֹשָׁה שָׁבוּעוֹת וְאַרְבָּעָה יָמִים בָּעֹמֶר:", "היום עֶשְׂרִים וְשִׁשָּׁה יוֹם שֶׁהֵם שְׁלֹשָׁה שָׁבוּעוֹת וַחֲמִשָּׁה יָמִים בָּעֹמֶר:", // This is omerCounts[25] - Day 26
        "היום עֶשְׂרִים וְשִׁבְעָה יוֹם שֶׁהֵם שְׁלֹשָׁה שָׁבוּעוֹת וְשִׁשָּׁה יָמִים בָּעֹמֶר:", // This is omerCounts[26] - Day 27
        "היום עֶשְׂרִים וּשְׁמוֹנֶה יוֹם שֶׁהֵם אַרְבָּעָה שָׁבוּעוֹת בָּעֹמֶר:",
        "היום עֶשְׂרִים וְתִשְׁעָה יוֹם שֶׁהֵם אַרְבָּעָה שָׁבוּעוֹת וְיוֹם אֶחָד בָּעֹמֶר:", "היום שְׁלוֹשִׁים יוֹם שֶׁהֵם אַרְבָּעָה שָׁבוּעוֹת וּשְׁנֵי יָמִים בָּעֹמֶר:",
        "היום שְׁלוֹשִׁים וְאֶחָד יוֹם שֶׁהֵם אַרְבָּעָה שָׁבוּעוֹת וּשְׁלוֹשָׁה יָמִים בָּעֹמֶר:", "היום שְׁלוֹשִׁים וּשְׁנַיִם יוֹם שֶׁהֵם אַרְבָּעָה שָׁבוּעוֹת וְאַרְבָּעָה יָמִים בָּעֹמֶר:",
        "היום שְׁלוֹשִׁים וּשְׁלוֹשָׁה יוֹם שֶׁהֵם אַרְבָּעָה שָׁבוּעוֹת וַחֲמִשָּׁה יָמִים בָּעֹמֶר:", "היום שְׁלוֹשִׁים וְאַרְבָּעָה יוֹם שֶׁהֵם אַרְבָּעָה שָׁבוּעוֹת וְשִׁשָּׁה יָמִים בָּעֹמֶר:",
        "היום שְׁלוֹשִׁים וַחֲמִשָּׁה יוֹם שֶׁהֵם חֲמִשָּׁה שָׁבוּעוֹת בָּעֹמֶר:", "היום שְׁלוֹשִׁים וְשִׁשָּׁה יוֹם שֶׁהֵם חֲמִשָּׁה שָׁבוּעוֹת וְיוֹם אֶחָד בָּעֹמֶר:",
        "היום שְׁלוֹשִׁים וְשִׁבְעָה יוֹם שֶׁהֵם חֲמִשָּׁה שָׁבוּעוֹת וּשְׁנֵי יָמִים בָּעֹמֶר:", "היום שְׁלוֹשִׁים וּשְׁמוֹנֶה יוֹם שֶׁהֵם חֲמִשָּׁה שָׁבוּעוֹת וּשְׁלוֹשָׁה יָמִים בָּעֹמֶר:",
        "היום שְׁלוֹשִׁים וְתִשְׁעָה יוֹם שֶׁהֵם חֲמִשָּׁה שָׁבוּעוֹת וְאַרְבָּעָה יָמִים בָּעֹמֶר:", "היום אַרְבָּעִים יוֹם שֶׁהֵם חֲמִשָּׁה שָׁבוּעוֹת וַחֲמִשָּׁה יָמִים בָּעֹמֶר:",
        "היום אַרְבָּעִים וְאֶחָד יוֹם שֶׁהֵם חֲמִשָּׁה שָׁבוּעוֹת וְשִׁשָּׁה יָמִים בָּעֹמֶר:", "היום אַרְבָּעִים וּשְׁנַיִם יוֹם שֶׁהֵם שִׁשָּׁה שָׁבוּעוֹת בָּעֹמֶר:",
        "היום אַרְבָּעִים וּשְׁלוֹשָׁה יוֹם שֶׁהֵם שִׁשָּׁה שָׁבוּעוֹת וְיוֹם אֶחָד בָּעֹמֶר:", "היום אַרְבָּעִים וְאַרְבָּעָה יוֹם שֶׁהֵם שִׁשָּׁה שָׁבוּעוֹת וּשְׁנֵي יָמִים בָּעֹמֶר:",
        "היום אַרְבָּעִים וַחֲמִשָּׁה יוֹם שֶׁהֵם שִׁשָּׁה שָׁבוּעוֹת וּשְׁלוֹשָׁה יָמִים בָּעֹמֶר:", "היום אַרְבָּעִים וְשִׁשָּׁה יוֹם שֶׁהֵם שִׁשָּׁה שָׁבוּעוֹת וְאַרְבָּעָה יָמִים בָּעֹמֶר:",
        "היום אַרְבָּעִים וְשִׁבְעָה יוֹם שֶׁהֵם שִׁשָּׁה שָׁבוּעוֹת וַחֲמִשָּׁה יָמִים בָּעֹמֶר:", "היום אַרְבָּעִים וּשְׁמוֹנֶה יוֹם שֶׁהֵם שִׁשָּׁה שָׁבוּעוֹת וְשִׁשָּׁה יָמִים בָּעֹמֶר:",
        "היום אַרְבָּעִים וְתִשְׁעָה יוֹם שֶׁהֵם שִׁבְעָה שָׁבוּעוֹת בָּעֹֽמֶר:"
    ];

    async function fetchSunset(lat, lng, date) {
      console.log("[LOG] fetchSunset called for date:", date.toLocaleDateString());
      const y = date.getFullYear();
      const m = (date.getMonth() + 1).toString().padStart(2, '0');
      const d = date.getDate().toString().padStart(2, '0');
      const dateString = `${y}-${m}-${d}`;
      // Corrected Hebcal API URL
      const url = `https://www.hebcal.com/zmanim?cfg=json&latitude=${lat}&longitude=${lng}&date=${dateString}`;
      console.log("[LOG] fetchSunset URL:", url);
      try {
        const res = await fetch(url);
        if (!res.ok) {
            console.error(`[LOG] HTTP error! status: ${res.status} for ${dateString}. Response:`, await res.text());
            throw new Error(`HTTP error! status: ${res.status} for ${dateString}`);
        }
        const data = await res.json();
        if (data.times && data.times.sunset) {
          const sunsetDate = new Date(data.times.sunset);
          console.log("[LOG] Sunset time fetched for " + dateString + ":", sunsetDate.toLocaleString());
          return sunsetDate;
        }
        console.warn("[LOG] Sunset time not found in API response for ", dateString, data);
        return null;
      } catch (error) {
        console.error("[LOG] Error fetching sunset for " + dateString + ":", error);
        return null;
      }
    }

    async function fetchHebrewDate(date) {
      console.log("[LOG] fetchHebrewDate called for date:", date.toLocaleDateString());
      const url = `https://www.hebcal.com/converter?cfg=json&gy=${date.getFullYear()}&gm=${date.getMonth()+1}&gd=${date.getDate()}&g2h=1`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        return `${data.hebrew} (${data.hy})`;
      } catch (error) {
        console.error("[LOG] Error fetching Hebrew date:", error);
        return "Error fetching Hebrew date";
      }
    }

    async function updateOutput(dateFromPickerInput) {
      console.log("----------------------------------------");
      console.log("[LOG] updateOutput called with dateFromPickerInput:", dateFromPickerInput.toString(), dateFromPickerInput.toLocaleString());

      const lat = window.__userLat;
      const lng = window.__userLng;
      const now = new Date(); // Current actual time
      console.log("[LOG] Current time (now):", now.toString(), now.toLocaleString());
      console.log("[LOG] User lat/lng:", lat, lng);

      // Normalized date from picker (local midnight)
      const pickerDate = new Date(dateFromPickerInput.getFullYear(), dateFromPickerInput.getMonth(), dateFromPickerInput.getDate());
      console.log("[LOG] pickerDate (normalized from input):", pickerDate.toString(), pickerDate.toLocaleString());

      let isAfterSunsetOnPickerDate = false;
      let sunsetOnPickerDateTime = null; // To store actual sunset time if fetched
      let usedFallback = false; // Flag to indicate if we used fallback logic
      const FALLBACK_SUNSET_HOUR = 21; // 9 PM local time as a fallback

      let effectiveDateForCalculation = new Date(pickerDate.getTime());
      let effectiveDateForDisplay = new Date(pickerDate.getTime());
      console.log("[LOG] Initial effectiveDateForCalculation:", effectiveDateForCalculation.toLocaleString());
      console.log("[LOG] Initial effectiveDateForDisplay:", effectiveDateForDisplay.toLocaleString());

      const instructionNote = document.getElementById('omerInstructionNote');

      if (lat && lng) {
        sunsetOnPickerDateTime = await fetchSunset(lat, lng, pickerDate);
        if (sunsetOnPickerDateTime) {
             console.log("[LOG] Actual sunset for pickerDate ("+pickerDate.toLocaleDateString()+") is at:", sunsetOnPickerDateTime.toLocaleString());
             if (now >= sunsetOnPickerDateTime) {
                isAfterSunsetOnPickerDate = true;
             }
        } else { // Sunset fetch failed despite having lat/lng
            console.warn("[LOG] Failed to get actual sunset despite lat/lng. Using fallback hour.");
            usedFallback = true;
            let fallbackSunsetOnPickerDate = new Date(pickerDate.getTime());
            fallbackSunsetOnPickerDate.setHours(FALLBACK_SUNSET_HOUR, 0, 0, 0);
            if (now >= fallbackSunsetOnPickerDate) {
                isAfterSunsetOnPickerDate = true;
            }
        }
      } else { // No lat/lng at all
        console.warn(`[LOG] No lat/lng. Using fallback sunset hour: ${FALLBACK_SUNSET_HOUR}:00 for ${pickerDate.toLocaleDateString()}`);
        usedFallback = true;
        let fallbackSunsetOnPickerDate = new Date(pickerDate.getTime());
        fallbackSunsetOnPickerDate.setHours(FALLBACK_SUNSET_HOUR, 0, 0, 0);
        console.log(`[LOG] Fallback check: now (${now.toLocaleString()}) vs. fallbackSunsetOnPickerDate (${fallbackSunsetOnPickerDate.toLocaleString()})`);

        if (now >= fallbackSunsetOnPickerDate) {
            isAfterSunsetOnPickerDate = true;
        }
      }
      console.log("[LOG] isAfterSunsetOnPickerDate (after fallback logic if any):", isAfterSunsetOnPickerDate);

      // Determine the core logic based on isAfterSunsetOnPickerDate
      if (isAfterSunsetOnPickerDate) {
        console.log("[LOG] Branch: isAfterSunsetOnPickerDate is TRUE.");
        // effectiveDateForCalculation and effectiveDateForDisplay remain as pickerDate
        instructionNote.innerText = `It's after sunset on ${pickerDate.toLocaleDateString()}. Displaying the Omer count for this evening.`;
      } else {
        console.log("[LOG] Branch: isAfterSunsetOnPickerDate is FALSE.");
        effectiveDateForCalculation.setDate(effectiveDateForCalculation.getDate() - 1);
        effectiveDateForDisplay.setDate(effectiveDateForDisplay.getDate() - 1);
        instructionNote.innerText = `It's before sunset on ${pickerDate.toLocaleDateString()}. Displaying Omer count from last night (${effectiveDateForDisplay.toLocaleDateString()}).`;
      }
      
      // Append fallback information to the note if fallback was used
      if (usedFallback) {
          instructionNote.innerText += ` (Location/sunset data unavailable; using ${FALLBACK_SUNSET_HOUR}:00 fallback).`;
      }

      console.log("[LOG] Final effectiveDateForCalculation:", effectiveDateForCalculation.toLocaleString());
      console.log("[LOG] Final effectiveDateForDisplay:", effectiveDateForDisplay.toLocaleString());
      
      const year = effectiveDateForCalculation.getFullYear();
      const omerStartDateString = startDates[year];
      console.log("[LOG] Year for Omer calculation:", year);
      console.log("[LOG] omerStartDateString for year " + year + ":", omerStartDateString);

      const output = document.getElementById('output');
      const actions = document.getElementById('actions');
      const hebrewDateEl = document.getElementById('hebrewDate');

      if (!omerStartDateString) {
        console.error("[LOG] Omer start date not defined for year:", year);
        output.innerHTML = `Omer start date not defined for ${year}.`;
        actions.innerHTML = '';
        hebrewDateEl.innerText = `Picker: ${pickerDate.toLocaleDateString()}, Effective Calculation: ${effectiveDateForCalculation.toLocaleDateString()}`;
        return;
      }

      const parts = omerStartDateString.split('-');
      const startYear = parseInt(parts[0], 10);
      const startMonth = parseInt(parts[1], 10) - 1; 
      const startDay = parseInt(parts[2], 10);
      const startOmerDateObj = new Date(startYear, startMonth, startDay); 
      console.log("[LOG] startOmerDateObj (corrected parsing, should be local midnight of omerStartDateString):", startOmerDateObj.toLocaleString(), startOmerDateObj.toUTCString());

      let tempCalcDate = new Date(effectiveDateForCalculation.getTime());
      tempCalcDate.setHours(0,0,0,0); 
      console.log("[LOG] tempCalcDate (for diff, normalized effectiveDateForCalculation):", tempCalcDate.toLocaleString(), tempCalcDate.toUTCString());

      const diffMilliseconds = tempCalcDate.getTime() - startOmerDateObj.getTime();
      console.log("[LOG] Milliseconds diff for Omer day:", diffMilliseconds);
      const diff = Math.floor(diffMilliseconds / (1000 * 60 * 60 * 24));
      console.log("[LOG] diff (days):", diff);
      const dayOfOmer = diff + 1;
      console.log("[LOG] dayOfOmer:", dayOfOmer);

      if (dayOfOmer < 1 || dayOfOmer > 49) {
        console.warn("[LOG] Calculated dayOfOmer ("+dayOfOmer+") is out of range.");
        output.innerHTML = `Not within the Omer count period for ${effectiveDateForDisplay.toLocaleDateString()}. (Calculated Day ${dayOfOmer})`;
        actions.innerHTML = '';
        hebrewDateEl.innerText = `Picker: ${pickerDate.toLocaleDateString()}, Effective Display: ${effectiveDateForDisplay.toLocaleDateString()}`;
        return;
      }

      const gregorianDateForImageISO = effectiveDateForDisplay.toISOString().slice(0, 10);
      const file = `${base}/omer_day_${dayOfOmer}_${gregorianDateForImageISO}.png`;
      console.log("[LOG] Image file:", file);
      output.innerHTML = `<img src="${file}" alt="Omer day ${dayOfOmer} - counted on evening of ${gregorianDateForImageISO}">`;

      const hebrew = await fetchHebrewDate(effectiveDateForDisplay);
      hebrewDateEl.innerText = `Hebrew Date (for count beginning evening of ${gregorianDateForImageISO}): ${hebrew}`;

      const countText = omerCounts[dayOfOmer - 1];
      if (!countText) {
          console.error("[LOG] Omer count text not found for dayOfOmer:", dayOfOmer, "(omerCounts index " + (dayOfOmer - 1) + ")");
      } else {
          console.log("[LOG] Omer count text for day " + dayOfOmer + ":", countText);
      }

      let shareText = '';
      if (!isAfterSunsetOnPickerDate) {
        shareText = `On ${pickerDate.toLocaleDateString()}, we show day ${dayOfOmer} of the Omer (counted evening of ${gregorianDateForImageISO}). If you haven't counted for ${gregorianDateForImageISO}, you can still count without a bracha until sunset of ${pickerDate.toLocaleDateString()}.\n\n${countText}`;
      } else {
        shareText = `The time to count the Omer for ${pickerDate.toLocaleDateString()} (Day ${dayOfOmer}) has come!\n\nבָּרוּךְ אַתָּה יְהֹוָה אֱלֺהֵֽינוּ מֶֽלֶךְ הָעוֹלָם אֲשֶׁר קִדְּשָֽׁנוּ בְּמִצְוֹתָיו וְצִוּנוּ עַל סְפִירַת הָעֹֽמֶר\n\n${countText}\n\nהָרַחֲמָן הוּא יַחֲזִיר לָנוּ עֲבוֹדַת בֵּית הַמִּקְדָּשׁ לִמְקוֹמָה בִּמְהֵרָה בְּיָמֵֽינוּ אָמֵן סֶֽלָה:`;
      }

      const encoded = encodeURIComponent(shareText);
      const calendarIsoDate = effectiveDateForDisplay.toISOString().slice(0,10).replace(/-/g, '');
      const calendarLink = `https://calendar.google.com/calendar/u/0/r/eventedit?text=Omer+Day+${dayOfOmer}&dates=${calendarIsoDate}T200000Z/${calendarIsoDate}T203000Z`;

      actions.innerHTML = `
        <p style="font-size:1.2em; font-weight:bold;">${countText || `Day ${dayOfOmer} text missing`}</p>
        <a class="button" href="https://wa.me/?text=${encoded}" target="_blank">📤 Share on WhatsApp</a>
        <a class="button" href="${calendarLink}" target="_blank">📅 Add to Calendar</a>
      `;
      console.log("----------------------------------------");
    }
    function initializePage() {
        console.log("[LOG] initializePage called");
        const today = new Date();
        const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        console.log("[LOG] Initializing with date:", todayDateOnly.toLocaleString());
        document.getElementById('datePicker').valueAsDate = todayDateOnly; // This sets it as YYYY-MM-DD for UTC midnight

        navigator.geolocation.getCurrentPosition(
            pos => {
                console.log("[LOG] Geolocation success:", pos.coords);
                window.__userLat = pos.coords.latitude;
                window.__userLng = pos.coords.longitude;
                updateOutput(todayDateOnly);
            },
            err => {
                console.warn("[LOG] Geolocation failed or denied:", err.message);
                window.__userLat = null;
                window.__userLng = null;
                updateOutput(todayDateOnly);
            },
            { timeout: 10000 }
        );
    }
    
    function getLocalDateFromPicker(pickerValueAsDate) {
        // pickerValueAsDate is a Date object representing midnight UTC on the selected date.
        // We want a Date object representing midnight in the local timezone.
        const localDate = new Date(pickerValueAsDate.getUTCFullYear(), pickerValueAsDate.getUTCMonth(), pickerValueAsDate.getUTCDate());
        console.log("[LOG] getLocalDateFromPicker: input(UTC midnight):", pickerValueAsDate.toUTCString(), "output(local midnight):", localDate.toLocaleString());
        return localDate;
    }

    document.getElementById('datePicker').addEventListener('change', e => {
      console.log("[LOG] Date picker changed. valueAsDate:", e.target.valueAsDate.toISOString());
      const localPickedDate = getLocalDateFromPicker(e.target.valueAsDate);
      updateOutput(localPickedDate);
    });

    document.getElementById('prevDay').addEventListener('click', () => {
      console.log("[LOG] PrevDay clicked.");
      const picker = document.getElementById('datePicker');
      let currentDate = getLocalDateFromPicker(picker.valueAsDate);
      currentDate.setDate(currentDate.getDate() - 1);
      // valueAsDate expects a date that will be treated as UTC midnight for display.
      // So convert our local date back to a UTC representation for the picker.
      picker.valueAsDate = new Date(Date.UTC(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()));
      console.log("[LOG] PrevDay: new picker date (UTC for picker):", picker.valueAsDate.toISOString());
      updateOutput(currentDate); // updateOutput works with local date
    });

    document.getElementById('nextDay').addEventListener('click', () => {
      console.log("[LOG] NextDay clicked.");
      const picker = document.getElementById('datePicker');
      let currentDate = getLocalDateFromPicker(picker.valueAsDate);
      currentDate.setDate(currentDate.getDate() + 1);
      picker.valueAsDate = new Date(Date.UTC(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()));
      console.log("[LOG] NextDay: new picker date (UTC for picker):", picker.valueAsDate.toISOString());
      updateOutput(currentDate);
    });

    initializePage();
  </script>
</body>
</html>
